(function(){var m,n,p,e=function(a,b){return function(){return a.apply(b,arguments)}},q=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},d=window,j=function(a){null==a&&(a={});this.uploadError=e(this.uploadError,this);this.uploadComplete=e(this.uploadComplete,this);this.uploadProgress=e(this.uploadProgress,this);this.embedCodeReady=e(this.embedCodeReady,this);this.uploadFile=e(this.uploadFile,this);this.off=e(this.off,this);this.on=e(this.on,this);
this.chunkProgress={};this.eventListeners={};this.initializeListeners(a)};j.prototype.initializeListeners=function(a){var b,c,f,h,g,d;g=["embedCodeReady","uploadProgress","uploadComplete","uploadError"];d=[];f=0;for(h=g.length;f<h;f++)b=g[f],c=null!=a[b]?a[b]instanceof Array?a[b]:[a[b]]:[],d.push(this.eventListeners[b]=c);return d};j.prototype.on=function(a,b){if(null==this.eventListeners[a])throw"invalid eventType";return this.eventListeners[a].push(b)};j.prototype.off=function(a,b){var c,f,h;null==
b&&(b=null);if(null==b)this.eventListeners[a]=[];else{f=this.eventListeners[a];for(h=[];0<=(c=f.indexOf(b));)h.push(f.splice(c,1));return h}};j.prototype.uploadFile=function(a,b){null==b&&(b={});if(!this.browserSupported)return!1;(new p({embedCodeReady:this.embedCodeReady,uploadProgress:this.uploadProgress,uploadComplete:this.uploadComplete,uploadError:this.uploadError})).uploadFile(a,b);return!0};j.prototype.embedCodeReady=function(a){var b,c,f,h,g;h=null!=(b=this.eventListeners.embedCodeReady)?
b:[];g=[];c=0;for(f=h.length;c<f;c++)b=h[c],g.push(b(a));return g};j.prototype.uploadProgress=function(a,b){var c,f,h,g,d;if(b!==this.chunkProgress[a]){this.chunkProgress[a]=b;g=null!=(c=this.eventListeners.uploadProgress)?c:[];d=[];f=0;for(h=g.length;f<h;f++)c=g[f],d.push(c(a,b));return d}};j.prototype.uploadComplete=function(a){var b,c,f,h,d;delete this.chunkProgress[a];h=null!=(b=this.eventListeners.uploadComplete)?b:[];d=[];c=0;for(f=h.length;c<f;c++)b=h[c],d.push(b(a));return d};j.prototype.uploadError=
function(a,b,c,f,d){var g,e,j,k,l;k=null!=(g=this.eventListeners.uploadError)?g:[];l=[];e=0;for(j=k.length;e<j;e++)g=k[e],l.push(g(a,b,c,f,d));return l};j.prototype.browserSupported="undefined"!==typeof FileReader&&null!==FileReader;d.OoyalaUploader=j;d=function(a){this.onError=e(this.onError,this);this.onAssetUploadComplete=e(this.onAssetUploadComplete,this);this.onChunkComplete=e(this.onChunkComplete,this);this.onChunkProgress=e(this.onChunkProgress,this);this.onUploadUrlsReceived=e(this.onUploadUrlsReceived,
this);this.onAssetCreated=e(this.onAssetCreated,this);this.createAsset=e(this.createAsset,this);this.uploadFile=e(this.uploadFile,this);var b,c,f,d;this.embedCodeReadyCallback=null!=(b=null!=a?a.embedCodeReady:void 0)?b:function(){};this.uploadProgressCallback=null!=(c=null!=a?a.uploadProgress:void 0)?c:function(){};this.uploadCompleteCallback=null!=(f=null!=a?a.uploadComplete:void 0)?f:function(){};this.uploadErrorCallback=null!=(d=null!=a?a.uploadError:void 0)?d:function(){};this.chunkUploaders=
{};this.completedChunkIndexes=[];this.completedChunks=0;this.totalChunks};d.prototype.uploadFile=function(a,b){var c,f,d,g,e,j,k,l,m,n;console.log("Uploading file using browser: "+navigator.userAgent);this.assetMetadata={assetCreationUrl:null!=(c=b.assetCreationUrl)?c:"/v2/assets",assetUploadingUrl:null!=(f=b.assetUploadingUrl)?f:"/v2/assets/assetID/uploading_urls",assetStatusUpdateUrl:null!=(d=b.assetStatusUpdateUrl)?d:"/v2/assets/assetID/upload_status",assetName:null!=(g=b.name)?g:a.name,assetDescription:null!=
(e=b.description)?e:"",assetType:null!=(j=b.assetType)?j:"video",fileSize:a.size,createdAt:(new Date).getTime(),assetLabels:null!=(k=b.labels)?k:[],postProcessingStatus:null!=(l=b.postProcessingStatus)?l:"live",labelCreationUrl:null!=(m=b.labelCreationUrl)?m:"/v2/labels/by_full_path/paths",labelAssignmentUrl:null!=(n=b.labelAssignmentUrl)?n:"/v2/assets/assetID/labels",assetID:""};return this.createAsset(a)};d.prototype.createAsset=function(a){var b=this;return jQuery.ajax({url:this.assetMetadata.assetCreationUrl,
type:"POST",data:{name:this.assetMetadata.assetName,description:this.assetMetadata.assetDescription,file_name:a.name,file_size:this.assetMetadata.fileSize,asset_type:this.assetMetadata.assetType,chunk_size:5242880,post_processing_status:this.assetMetadata.postProcessingStatus},success:function(c){return b.onAssetCreated(a,c)},error:function(a){return b.onError(a,"Asset creation error")}})};d.prototype.onAssetCreated=function(a,b){var c;c=JSON.parse(b);this.assetMetadata.assetID=c.embed_code;this.embedCodeReadyCallback(this.assetMetadata.assetID);
this.assetMetadata.assetLabels.filter(function(a){return a});0!==this.assetMetadata.assetLabels.length&&this.createLabels();return this.getUploadingUrls(a)};d.prototype.createLabels=function(){var a,b=this;a=this.assetMetadata.assetLabels.join(",");return jQuery.ajax({url:this.assetMetadata.labelCreationUrl.replace("paths",a),type:"POST",success:function(a){return b.assignLabels(a)},error:function(a){return b.onError(a,"Label creation error")}})};d.prototype.assignLabels=function(a){var b,c=this;
b=JSON.parse(a);var f,d,g;g=[];f=0;for(d=b.length;f<d;f++)a=b[f],g.push(a.id);return jQuery.ajax({url:this.assetMetadata.labelAssignmentUrl.replace("assetID",this.assetMetadata.assetID),type:"POST",data:JSON.stringify(g),success:function(a){return c.onLabelsAssigned(a)},error:function(a){return c.onError(a,"Label assignment error")}})};d.prototype.onLabelsAssigned=function(){return console.log("Creation and assignment of labels complete "+this.assetMetadata.assetLabels)};d.prototype.getUploadingUrls=
function(a){var b=this;return jQuery.ajax({url:this.assetMetadata.assetUploadingUrl.split("assetID").join(this.assetMetadata.assetID),data:{asset_id:this.assetMetadata.assetID},success:function(c){return b.onUploadUrlsReceived(a,c)},error:function(a){return b.onError(a,"Error getting the uploading urls")}})};d.prototype.onUploadUrlsReceived=function(a,b){var c,d,e=this;d=JSON.parse(b);this.totalChunks=d.length;c=(new n(a,5242880)).getChunks();c.length!==this.totalChunks&&console.log("Sliced chunks ("+
c.length+") and uploadingUrls ("+this.totalChunks+") disagree.");return jQuery.each(c,function(a,b){var c;if(!(0<=q.call(e.completedChunkIndexes,a)))return c=new m({assetMetadata:e.assetMetadata,chunkIndex:a,chunk:b,uploadUrl:d[a],progress:e.onChunkProgress,completed:e.onChunkComplete,error:e.uploadErrorCallback}),e.chunkUploaders[a]=c,c.startUpload()})};d.prototype.progressPercent=function(){var a,b,c,d;a=0;d=this.chunkUploaders;for(b in d)c=d[b],a+=c.bytesUploaded;return Math.min(100,Math.floor(100*
(5242880*this.completedChunks+a)/this.assetMetadata.fileSize))};d.prototype.onChunkProgress=function(){return this.uploadProgressCallback(this.assetMetadata.assetID,this.progressPercent())};d.prototype.onChunkComplete=function(a,b){this.completedChunks++;this.completedChunkIndexes.push(b);delete this.chunkUploaders[b];this.onChunkProgress();if(this.completedChunks===this.totalChunks)return this.onAssetUploadComplete()};d.prototype.onAssetUploadComplete=function(){var a=this;return jQuery.ajax({url:this.assetMetadata.assetStatusUpdateUrl.split("assetID").join(this.assetMetadata.assetID),
data:{asset_id:this.assetMetadata.assetID,status:"uploaded"},type:"PUT",success:function(){return a.uploadCompleteCallback(a.assetMetadata.assetID)},error:function(b){return a.onError(b,"Setting asset status as uploaded error")}})};d.prototype.onError=function(a,b){var c,d;try{d=JSON.parse(a.responseText),c=d.message}catch(e){c=a.statusText}console.log(""+this.assetMetadata.assetName+": "+b+" with status "+a.status+": "+c);return this.uploadErrorCallback({assetID:this.assetMetadata.assetID,type:this.assetMetadata.assetType,
fileName:this.assetMetadata.assetName,statusCode:a.status,message:""+b+", "+c})};p=d;d=function(a){this.onXhrError=e(this.onXhrError,this);this.onXhrLoad=e(this.onXhrLoad,this);this.startUpload=e(this.startUpload,this);this.assetMetadata=a.assetMetadata;this.chunk=a.chunk;this.chunkIndex=a.chunkIndex;this.progressHandler=a.progress;this.completedHandler=a.completed;this.uploadErrorCallback=a.error;this.uploadUrl=a.uploadUrl;this.bytesUploaded=0};d.prototype.startUpload=function(){var a=this;console.log(""+
this.assetMetadata.assetID+": Starting upload of chunk "+this.chunkIndex);this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",function(b){a.bytesUploaded=b.loaded;return a.progressHandler()});this.xhr.addEventListener("load",this.onXhrLoad);this.xhr.addEventListener("error",this.onXhrError);this.xhr.open("PUT",this.uploadUrl);return this.xhr.send(this.chunk)};d.prototype.onXhrLoad=function(a){if(400<=a.target.status)return onXhrError(a);this.bytesUploaded=5242880;return this.completedHandler(a,
this.chunkIndex)};d.prototype.onXhrError=function(a){console.log(""+this.assetMetadata.assetID+": chunk "+this.chunkIndex+": Xhr Error Status "+a.target.status);return this.uploadErrorCallback({assetID:this.assetMetadata.assetID,type:this.assetMetadata.assetType,fileName:this.assetMetadata.assetName,statusCode:a.status,message:a.responseText})};m=d;d=function(a,b){this.file=a;this.chunkSize=b};d.prototype.getChunks=function(){var a,b,c,d;if(!this.file.slice&&!this.file.mozSlice)return[this.file];
d=[];a=b=0;for(c=Math.ceil(this.file.size/this.chunkSize);0<=c?b<c:b>c;a=0<=c?++b:--b)d.push(this.slice(a*this.chunkSize,(a+1)*this.chunkSize));return d};d.prototype.slice=function(a,b){if(this.file.slice)return this.file.slice(a,b);if(this.file.mozSlice)return this.file.mozSlice(a,b)};n=d}).call(this);
